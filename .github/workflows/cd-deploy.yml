name: MLOps CD Deploy
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: [test]  # Run only if CI green
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install system deps (jq/bc for MLFlow parsing)
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc
    - name: Install Python deps
      run: |
        pip install -r requirements.txt apache-airflow mlflow
    - name: Start Mock MLFlow Server (for CI)
      run: |
        mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow_ci.db --default-artifact-root ./mlruns_ci &  # Background mock server
        sleep 10  # Wait startup
        echo "MLFlow mock ready on localhost:5000"
    - name: Run Pipeline & Deploy Model
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}  # Fallback mock
        OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      run: |
        # Full run via script
        python scripts/run_pipeline.py --season 2021 --ci
        # Get latest run_id (use jq now installed)
        EXPERIMENT_ID=$(mlflow experiments list --output json | jq -r '.experiments[] | select(.name=="sport_impact_v1") | .experiment_id')
        RUN_ID=$(mlflow runs list --experiment-id $EXPERIMENT_ID --output json | jq -r '.[-1].run_id')
        # Tag prod if R¬≤>0.7
        R2=$(mlflow runs get --run-id $RUN_ID --output json | jq -r '.data.metrics.test_r2')
        if (( $(echo "$R2 > 0.7" | bc -l) )); then
          mlflow models stage -m "runs:/$RUN_ID/random_forest_model" -n prod_model
          echo "‚úÖ Prod model deployed!"
        else
          echo "‚ö†Ô∏è R¬≤ $R2 < 0.7 - Skip deploy"
        fi
        # Sync DAG (simulate for CI; real: rsync to Airflow server)
        echo "DAG synced to prod (rsync airflow/dags/ user@airflow-server:/dags/)"
    - name: Notify Success
      if: success()
      run: |
        echo "üéâ Deployment successful - Prod model tagged! Check MLFlow."
    - name: Cleanup Mock Server
      if: always()
      run: |
        pkill -f mlflow  # Kill mock server